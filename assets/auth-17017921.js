import{L as h,G as m}from"./index-d2bf20c5.js";import{a as g}from"./axios-78d57de0.js";const d="http://localhost:3000/api/v1",p=!1,n=g.create({baseURL:d,timeout:1e4,headers:{"Content-Type":"application/json"}});n.interceptors.request.use(e=>{const t=localStorage.getItem("auth:token");return t&&(e.headers.Authorization=`Bearer ${t}`),e});const f=h("auth",{state:()=>({user:JSON.parse(localStorage.getItem("auth:user")||"null"),token:localStorage.getItem("auth:token")||null,passwordResetRequests:JSON.parse(localStorage.getItem("auth:passwordResetRequests")||"[]")}),actions:{async login({email:e,password:t}){var a,i,u,c;try{const r=m();(a=r.users)!=null&&a.length||await r.loadFromStorage();const s=await r.verifyCredentials(e,t);if(s)return this.user=s,this.token="local-"+Date.now(),localStorage.setItem("auth:user",JSON.stringify(s)),localStorage.setItem("auth:token",this.token),localStorage.setItem("mock:currentUser",JSON.stringify(s)),s}catch{}try{const r=await n.post("/auth/login",{email:e.trim().toLowerCase(),password:t}),s=((i=r.data)==null?void 0:i.data)||r.data||{},o=s.user||s,l=s.accessToken||s.token;if(!o||!o.id||!o.role)throw new Error("Invalid response from server");return this.user=o,this.token=l,localStorage.setItem("auth:user",JSON.stringify(o)),localStorage.setItem("auth:token",l),localStorage.setItem("mock:currentUser",JSON.stringify(o)),o}catch(r){if(r.response){const s=r.response.status,o=((u=r.response.data)==null?void 0:u.message)||((c=r.response.data)==null?void 0:c.error);throw s===401?new Error(o||"Invalid email or password"):s===429?new Error("Too many login attempts. Please try again later"):s===403?new Error("Account is disabled. Contact administrator"):new Error(o||`Login failed (Error ${s})`)}else throw r.request?new Error("Cannot connect to server. Please check your connection"):new Error(r.message||"Login failed. Please try again")}},async quickSignIn(e="student"){const t={id:Date.now(),name:`${e.charAt(0).toUpperCase()+e.slice(1)} User`,email:`${e}@dev.local`,role:e,firstName:e.charAt(0).toUpperCase()+e.slice(1),lastName:"User"};return this.user=t,this.token="mock-jwt-token-"+Date.now(),localStorage.setItem("auth:user",JSON.stringify(t)),localStorage.setItem("auth:token",this.token),localStorage.setItem("mock:currentUser",JSON.stringify(t)),Promise.resolve(t)},async logout(){try{this.token&&await n.post("/auth/logout").catch(()=>{})}finally{this.user=null,this.token=null,localStorage.removeItem("auth:user"),localStorage.removeItem("auth:token"),localStorage.removeItem("mock:currentUser")}},async requestPasswordReset(e){const t={id:Date.now(),email:e.trim().toLowerCase(),timestamp:new Date().toISOString(),status:"pending",type:"password_reset"};return this.passwordResetRequests.push(t),localStorage.setItem("auth:passwordResetRequests",JSON.stringify(this.passwordResetRequests)),t},async getResetRequests(){return this.passwordResetRequests},async markResetRequestComplete(e){const t=this.passwordResetRequests.find(a=>a.id===e);return t&&(t.status="completed",t.completedAt=new Date().toISOString(),localStorage.setItem("auth:passwordResetRequests",JSON.stringify(this.passwordResetRequests))),t},async validateSession(){const e=localStorage.getItem("auth:user"),t=localStorage.getItem("auth:token");return e&&t?(this.user=JSON.parse(e),this.token=t,!0):!1}},getters:{isAuthenticated:e=>!!e.user&&!!e.token,isTeacher:e=>{var t;return((t=e.user)==null?void 0:t.role)==="teacher"},isAdmin:e=>{var t;return((t=e.user)==null?void 0:t.role)==="admin"},isStudent:e=>{var t;return((t=e.user)==null?void 0:t.role)==="student"},currentUser:e=>e.user,pendingResetRequests:e=>e.passwordResetRequests.filter(t=>t.status==="pending"),isProduction:()=>p}});export{f as u};
