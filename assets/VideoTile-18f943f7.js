import{r as l,z as j,_ as z,c as L,s as q,o as W,a as u,b as d,e as i,n as V,t as k,h as m}from"./index-e0178975.js";function we(){const e=l(null),E=l(null),c=l(new Map),v=l(!1),f=l(!1),C=l(!1),S=l([]),T=l([]),M=l([]),p=l(null),g=l(null),h=l(!1),s=l(null),y=l("excellent"),D=l(new Map);async function B(){try{const t=await navigator.mediaDevices.enumerateDevices();return S.value=t.filter(a=>a.kind==="videoinput"),T.value=t.filter(a=>a.kind==="audioinput"),M.value=t.filter(a=>a.kind==="audiooutput"),S.value.length>0&&!p.value&&(p.value=S.value[0].deviceId),T.value.length>0&&!g.value&&(g.value=T.value[0].deviceId),{cameras:S.value,microphones:T.value,speakers:M.value}}catch(t){throw console.error("Error getting media devices:",t),s.value="Failed to access media devices",t}}async function o(t={}){try{h.value=!0,s.value=null;const a={video:t.video!==!1?{deviceId:p.value?{exact:p.value}:void 0,width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}}:!1,audio:t.audio!==!1?{deviceId:g.value?{exact:g.value}:void 0,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}:!1},r=await navigator.mediaDevices.getUserMedia(a);return e.value=r,v.value=r.getVideoTracks().length>0,f.value=r.getAudioTracks().length>0,h.value=!1,r}catch(a){throw h.value=!1,a.name==="NotAllowedError"||a.name==="PermissionDeniedError"?s.value="Camera/microphone access denied. Please allow permissions in your browser.":a.name==="NotFoundError"?s.value="No camera or microphone found on your device.":a.name==="NotReadableError"?s.value="Camera or microphone is already in use by another application.":s.value="Failed to access camera/microphone: "+a.message,console.error("Error starting local stream:",a),a}}function n(){e.value&&(e.value.getTracks().forEach(t=>t.stop()),e.value=null,v.value=!1,f.value=!1)}async function w(){if(!e.value){await o({video:!0,audio:f.value});return}const t=e.value.getVideoTracks()[0];if(t)t.enabled?(t.enabled=!1,v.value=!1):(t.enabled=!0,v.value=!0);else try{const r=(await navigator.mediaDevices.getUserMedia({video:{deviceId:p.value?{exact:p.value}:void 0,width:{ideal:1280},height:{ideal:720}}})).getVideoTracks()[0];e.value.addTrack(r),v.value=!0}catch(a){throw console.error("Error adding video track:",a),s.value="Failed to turn on camera",a}}async function F(){try{if(!e.value){const a=await navigator.mediaDevices.getUserMedia({audio:{deviceId:g.value?{exact:g.value}:void 0,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1});e.value=a,f.value=!0;return}const t=e.value.getAudioTracks()[0];if(t)t.enabled=!t.enabled,f.value=t.enabled;else{const r=(await navigator.mediaDevices.getUserMedia({audio:{deviceId:g.value?{exact:g.value}:void 0,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})).getAudioTracks()[0];e.value.addTrack(r),f.value=!0}}catch(t){throw console.error("Error toggling microphone:",t),s.value="Failed to access or toggle microphone",t}}async function U(t){if(e.value)try{const a=e.value.getVideoTracks()[0];a&&(a.stop(),e.value.removeTrack(a));const b=(await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:t},width:{ideal:1280},height:{ideal:720}}})).getVideoTracks()[0];e.value.addTrack(b),p.value=t,v.value=!0}catch(a){throw console.error("Error switching camera:",a),s.value="Failed to switch camera",a}}async function $(t){if(e.value)try{const a=e.value.getAudioTracks()[0];a&&(a.stop(),e.value.removeTrack(a));const b=(await navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:t},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})).getAudioTracks()[0];e.value.addTrack(b),g.value=t,f.value=!0}catch(a){throw console.error("Error switching microphone:",a),s.value="Failed to switch microphone",a}}async function P(){try{const t=await navigator.mediaDevices.getDisplayMedia({video:{cursor:"always"},audio:!1});return E.value=t,C.value=!0,t.getVideoTracks()[0].onended=()=>{I()},t}catch(t){throw console.error("Error starting screen share:",t),s.value="Failed to start screen sharing",t}}function I(){E.value&&(E.value.getTracks().forEach(t=>t.stop()),E.value=null,C.value=!1)}function G(t){if(!t)return 0;try{const a=new(window.AudioContext||window.webkitAudioContext),r=a.createAnalyser(),b=a.createMediaStreamSource(t),A=new Uint8Array(r.frequencyBinCount);return b.connect(r),r.fftSize=256,()=>(r.getByteFrequencyData(A),A.reduce((O,Q)=>O+Q)/A.length/255)}catch(a){return console.error("Error getting audio level:",a),()=>0}}function N(t){if(!t)return;const a=setInterval(async()=>{try{const r=await t.getStats();let b=0,A=0;if(r.forEach(x=>{x.type==="inbound-rtp"&&x.kind==="video"&&(b=x.packetsLost||0,A=x.packetsReceived||0)}),A>0){const x=b/(b+A);x<.02?y.value="excellent":x<.05?y.value="good":x<.1?y.value="fair":y.value="poor"}}catch(r){console.error("Error monitoring connection quality:",r)}},2e3);return()=>clearInterval(a)}function R(){n(),I(),D.value.forEach(t=>t.close()),D.value.clear(),c.value.clear()}return j(()=>{R()}),{localStream:e,screenStream:E,remoteStreams:c,isCameraOn:v,isMicrophoneOn:f,isScreenSharing:C,isConnecting:h,connectionError:s,connectionQuality:y,cameras:S,microphones:T,speakers:M,selectedCamera:p,selectedMicrophone:g,getMediaDevices:B,startLocalStream:o,stopLocalStream:n,toggleCamera:w,toggleMicrophone:F,switchCamera:U,switchMicrophone:$,startScreenShare:P,stopScreenShare:I,getAudioLevel:G,monitorConnectionQuality:N,cleanup:R}}const Y=["muted"],H={key:0,class:"absolute inset-0 flex items-center justify-center bg-gradient-to-br from-gray-700 to-gray-800"},J={class:"text-center"},K={class:"text-white text-sm font-medium"},X={class:"absolute top-2 left-2 flex items-center space-x-1"},Z={key:0,class:"bg-red-500 px-2 py-1 rounded-full flex items-center space-x-1"},_={key:1,class:"bg-yellow-500 px-2 py-1 rounded-full animate-pulse"},ee={key:2,class:"bg-blue-500 px-2 py-1 rounded-full flex items-center space-x-1"},te={key:1,class:"absolute top-2 right-2"},ae={class:"text-white text-xs"},ne={class:"absolute bottom-2 left-2 right-2 flex items-center justify-between"},oe={class:"bg-black/70 px-2 py-1 rounded flex items-center space-x-1 flex-1 min-w-0"},ie={class:"material-icons text-white text-xs"},re={class:"text-white text-xs font-medium truncate"},se={key:0,class:"text-xs px-1 py-0.5 bg-blue-500 text-white rounded"},le={key:0,class:"ml-2 flex items-center space-x-1"},ce={key:2,class:"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center space-x-2"},ue=["title"],de={class:"material-icons text-sm"},ve=["title"],me={class:"material-icons text-sm"},fe=["title"],ge={class:"material-icons text-sm"},pe={__name:"VideoTile",props:{participant:{type:Object,required:!0},stream:{type:MediaStream,default:null},isLocalStream:{type:Boolean,default:!1},isScreenShare:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0},canControl:{type:Boolean,default:!1},canPin:{type:Boolean,default:!1},isPinned:{type:Boolean,default:!1},showConnectionQuality:{type:Boolean,default:!1}},emits:["mute-participant","toggle-video","lower-hand","remove-participant","toggle-pin"],setup(e,{emit:E}){const c=e,v=l(null),f=l(!1),C=l("good"),S=L(()=>c.participant.video&&c.stream),T=L(()=>{const o=c.participant.name||"Guest",n=o.split(" ");return n.length>=2?`${n[0][0]}${n[1][0]}`.toUpperCase():o.substring(0,2).toUpperCase()}),M=L(()=>{const o=["bg-blue-500","bg-green-500","bg-purple-500","bg-pink-500","bg-indigo-500","bg-yellow-500","bg-red-500"],n=c.participant.id?String(c.participant.id).charCodeAt(0)%o.length:0;return o[n]}),p=L(()=>{const o=C.value.toLowerCase();return o==="excellent"?"border-green-500":o==="good"?"border-blue-500":o==="fair"?"border-yellow-500":o==="poor"?"border-red-500":"border-gray-500"}),g=L(()=>{const o=C.value.toLowerCase();return o==="excellent"?"bg-green-500":o==="good"?"bg-blue-500":o==="fair"?"bg-yellow-500":o==="poor"?"bg-red-500":"bg-gray-500"});q(()=>c.stream,o=>{v.value&&o?v.value.srcObject=o:v.value&&(v.value.srcObject=null)},{immediate:!0});let h=null,s=null,y=null;function D(){if(!(!c.stream||!c.participant.audio))try{let w=function(){s.getByteFrequencyData(n);const F=n.reduce((U,$)=>U+$)/n.length;f.value=F>30,y=requestAnimationFrame(w)};h=new(window.AudioContext||window.webkitAudioContext),s=h.createAnalyser(),h.createMediaStreamSource(c.stream).connect(s),s.fftSize=256;const n=new Uint8Array(s.frequencyBinCount);w()}catch(o){console.error("Error setting up audio detection:",o)}}function B(){y&&cancelAnimationFrame(y),h&&h.close()}return W(()=>{c.stream&&D()}),j(()=>{B()}),q(()=>[c.stream,c.participant.audio],()=>{B(),c.stream&&c.participant.audio&&setTimeout(()=>D(),100)}),(o,n)=>(u(),d("div",{class:V(["relative bg-gray-900 rounded-lg overflow-hidden group",[f.value?"ring-2 ring-green-500":"",e.isScreenShare?"col-span-2 row-span-2":""]])},[i("video",{ref_key:"videoRef",ref:v,class:V(["w-full h-full object-cover",{mirror:e.isLocalStream&&!e.isScreenShare}]),autoplay:"",playsinline:"",muted:e.isLocalStream},null,10,Y),S.value?m("",!0):(u(),d("div",H,[i("div",J,[i("div",{class:V(["w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-3 flex items-center justify-center text-white text-2xl font-bold",M.value])},k(T.value),3),i("div",K,k(e.participant.name),1)])])),i("div",X,[e.participant.audio?m("",!0):(u(),d("div",Z,[...n[5]||(n[5]=[i("span",{class:"material-icons text-xs"},"mic_off",-1)])])),e.participant.handRaised?(u(),d("div",_,[...n[6]||(n[6]=[i("span",{class:"material-icons text-xs"},"front_hand",-1)])])):m("",!0),e.isScreenShare?(u(),d("div",ee,[...n[7]||(n[7]=[i("span",{class:"material-icons text-xs"},"screen_share",-1),i("span",{class:"text-xs"},"Screen",-1)])])):m("",!0)]),e.showConnectionQuality?(u(),d("div",te,[i("div",{class:V(["flex items-center space-x-1 bg-black/50 px-2 py-1 rounded-full",p.value])},[i("div",{class:V(["w-2 h-2 rounded-full",g.value])},null,2),i("span",ae,k(C.value),1)],2)])):m("",!0),i("div",ne,[i("div",oe,[i("span",ie,k(e.participant.role==="teacher"?"school":"person"),1),i("span",re,k(e.participant.name)+k(e.isLocalStream?" (You)":""),1),e.participant.role==="teacher"?(u(),d("span",se," Teacher ")):m("",!0)]),f.value&&e.participant.audio?(u(),d("div",le,[...n[8]||(n[8]=[i("div",{class:"w-1 h-2 bg-green-500 rounded animate-pulse"},null,-1),i("div",{class:"w-1 h-3 bg-green-500 rounded animate-pulse",style:{"animation-delay":"0.1s"}},null,-1),i("div",{class:"w-1 h-2 bg-green-500 rounded animate-pulse",style:{"animation-delay":"0.2s"}},null,-1)])])):m("",!0)]),e.showControls&&e.canControl?(u(),d("div",ce,[e.isLocalStream?m("",!0):(u(),d("button",{key:0,onClick:n[0]||(n[0]=w=>o.$emit("mute-participant",e.participant)),class:"bg-gray-700 hover:bg-gray-600 p-2 rounded-full text-white transition-colors",title:e.participant.audio?"Mute":"Unmute"},[i("span",de,k(e.participant.audio?"mic_off":"mic"),1)],8,ue)),e.isLocalStream?m("",!0):(u(),d("button",{key:1,onClick:n[1]||(n[1]=w=>o.$emit("toggle-video",e.participant)),class:"bg-gray-700 hover:bg-gray-600 p-2 rounded-full text-white transition-colors",title:e.participant.video?"Turn off video":"Turn on video"},[i("span",me,k(e.participant.video?"videocam_off":"videocam"),1)],8,ve)),!e.isLocalStream&&e.participant.handRaised?(u(),d("button",{key:2,onClick:n[2]||(n[2]=w=>o.$emit("lower-hand",e.participant)),class:"bg-yellow-500 hover:bg-yellow-600 p-2 rounded-full text-white transition-colors",title:"Lower hand"},[...n[9]||(n[9]=[i("span",{class:"material-icons text-sm"},"downloading",-1)])])):m("",!0),e.isLocalStream?m("",!0):(u(),d("button",{key:3,onClick:n[3]||(n[3]=w=>o.$emit("remove-participant",e.participant)),class:"bg-red-500 hover:bg-red-600 p-2 rounded-full text-white transition-colors",title:"Remove from class"},[...n[10]||(n[10]=[i("span",{class:"material-icons text-sm"},"person_remove",-1)])]))])):m("",!0),e.canPin?(u(),d("button",{key:3,onClick:n[4]||(n[4]=w=>o.$emit("toggle-pin",e.participant)),class:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 bg-gray-700 hover:bg-gray-600 p-1 rounded-full text-white transition-all z-10",title:e.isPinned?"Unpin":"Pin participant"},[i("span",ge,k((e.isPinned,"push_pin")),1)],8,fe)):m("",!0)],2))}},be=z(pe,[["__scopeId","data-v-784a4adc"],["__file","/home/buddy/GCO/src/components/live/VideoTile.vue"]]);export{be as V,we as u};
